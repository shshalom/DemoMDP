/**
 * Gateway command - Run gateway in MCP server mode
 */
import { createResolver } from '@mdp-framework/gateway';
import { createCapsuleStore } from '@mdp-framework/gateway/store';
import { PolicyRegistry } from '@mdp-framework/adapters';
import { createMCPServer } from '@mdp-framework/mcp-server';
export async function runGateway(logger, options) {
    const basePath = options.basePath || '.mlang';
    const mode = options.mode || 'mcp';
    if (mode !== 'mcp') {
        throw new Error(`Unsupported gateway mode: ${mode}`);
    }
    logger.info('Starting MCP Gateway...');
    // Determine transport mode
    let transportMode = 'stdio';
    let port;
    if (options.http) {
        transportMode = 'http';
        port = options.port || 8080;
    }
    else if (options.stdio) {
        transportMode = 'stdio';
    }
    try {
        // Setup resolver
        const policyPath = `${basePath}/policies`;
        const registry = new PolicyRegistry({ basePath: policyPath });
        const resolver = createResolver({ registries: [registry] });
        logger.info(`Policy registry: ${policyPath}`);
        // Setup store
        const storePath = `${basePath}/state/capsules`;
        const store = await createCapsuleStore({
            backend: 'file',
            baseDir: storePath,
        });
        logger.info(`Capsule store: ${storePath}`);
        // Create MCP server
        const server = createMCPServer({ resolver, store });
        logger.info(`Starting MCP server in ${transportMode} mode...`);
        if (transportMode === 'http' && port) {
            logger.info(`HTTP server listening on port ${port}`);
        }
        // Start server
        await server.start(transportMode, port);
        const status = server.getStatus();
        logger.info(`MCP server started with ${status.toolCount} tools`);
        if (options.verbose) {
            logger.info('Available tools:');
            server.getTools().forEach((tool) => {
                logger.info(`  - ${tool.name}: ${tool.description}`);
            });
        }
        // Handle graceful shutdown
        const shutdown = async () => {
            logger.info('Shutting down MCP server...');
            await server.stop();
            await store.close();
            process.exit(0);
        };
        process.on('SIGINT', shutdown);
        process.on('SIGTERM', shutdown);
        // Keep process alive for stdio mode
        if (transportMode === 'stdio') {
            // Server will stay alive processing stdin
        }
        else {
            // For HTTP mode, keep process alive
            await new Promise(() => { });
        }
    }
    catch (error) {
        logger.error(`Failed to start MCP gateway: ${error instanceof Error ? error.message : 'Unknown error'}`);
        throw error;
    }
}
//# sourceMappingURL=gateway.js.map