{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://mdp.dev/schemas/envelope/v1",
    "title": "Envelope",
    "description": "Execution envelope containing policy results, evidence, and observability data",
    "type": "object",
    "required": ["id", "version", "timestamp", "status"],
    "properties": {
        "id": {
            "type": "string",
            "description": "Unique envelope identifier (UUID or similar)",
            "pattern": "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$"
        },
        "version": {
            "type": "string",
            "description": "Envelope schema version",
            "const": "v1"
        },
        "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp of envelope creation"
        },
        "status": {
            "type": "string",
            "description": "Overall execution status",
            "enum": ["success", "warning", "failure", "error"]
        },
        "execution": {
            "type": "object",
            "description": "Execution context and metadata",
            "required": ["mode", "duration_ms"],
            "properties": {
                "mode": {
                    "type": "string",
                    "enum": ["enforce", "report", "dry-run"]
                },
                "duration_ms": {
                    "type": "integer",
                    "minimum": 0
                },
                "host": {
                    "type": "string",
                    "description": "Execution environment (ci, ide, cli)"
                },
                "triggered_by": {
                    "type": "string",
                    "description": "User or event that triggered execution"
                }
            }
        },
        "capsule_id": {
            "type": "string",
            "description": "Reference to associated StateCapsule",
            "pattern": "^capsule://[a-z0-9_-]+/[A-Z0-9_-]+/[a-z0-9_-]+/[a-z0-9_-]+$"
        },
        "policy_ids": {
            "type": "array",
            "description": "Resolved policy IDs used (id@YYYY.MM.DD - never channels)",
            "items": {
                "type": "string",
                "pattern": "^[a-z][a-z0-9-]*(?:\\.[a-z][a-z0-9-]*)+@[0-9]{4}\\.[0-9]{2}\\.[0-9]{2}$"
            }
        },
        "resolver": {
            "type": "object",
            "description": "Policy resolution metadata",
            "properties": {
                "snapshot_time": {
                    "type": "string",
                    "format": "date-time",
                    "description": "Time when policies were resolved (tâ‚€)"
                },
                "channel": {
                    "type": "string",
                    "description": "Channel used for resolution (stable, preview, dev)"
                },
                "degraded": {
                    "type": "boolean",
                    "description": "True if LKG fallback was used"
                }
            }
        },
        "results": {
            "type": "array",
            "description": "Policy evaluation results",
            "items": {
                "type": "object",
                "required": ["policy_id", "outcome"],
                "properties": {
                    "policy_id": {
                        "type": "string"
                    },
                    "outcome": {
                        "type": "string",
                        "enum": ["pass", "warn", "fail"]
                    },
                    "violations": {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "message": {
                                    "type": "string"
                                },
                                "location": {
                                    "type": "object",
                                    "properties": {
                                        "file": { "type": "string" },
                                        "line": { "type": "integer" },
                                        "column": { "type": "integer" }
                                    }
                                },
                                "severity": {
                                    "type": "string",
                                    "enum": ["info", "warning", "error"]
                                }
                            }
                        }
                    },
                    "duration_ms": {
                        "type": "integer"
                    }
                }
            }
        },
        "evidence_ids": {
            "type": "array",
            "description": "References to attached evidence",
            "items": {
                "type": "string"
            }
        },
        "actions": {
            "type": "array",
            "description": "Actions taken or suggested",
            "items": {
                "type": "object",
                "required": ["type"],
                "properties": {
                    "type": {
                        "type": "string",
                        "enum": ["comment", "check", "patch", "notify", "block"]
                    },
                    "status": {
                        "type": "string",
                        "enum": ["pending", "completed", "failed"]
                    },
                    "ref": {
                        "type": "string",
                        "description": "Reference to created resource (comment URL, check ID)"
                    },
                    "metadata": {
                        "type": "object",
                        "additionalProperties": true
                    }
                }
            }
        },
        "artifacts": {
            "type": "object",
            "description": "Generated artifacts (patches, reports)",
            "additionalProperties": {
                "type": "object",
                "properties": {
                    "type": {
                        "type": "string"
                    },
                    "ref": {
                        "type": "string"
                    },
                    "hash": {
                        "type": "string"
                    }
                }
            }
        },
        "observability": {
            "type": "object",
            "description": "Telemetry and observability data",
            "properties": {
                "trace_id": {
                    "type": "string"
                },
                "span_id": {
                    "type": "string"
                },
                "events": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "timestamp": {
                                "type": "string",
                                "format": "date-time"
                            },
                            "type": {
                                "type": "string"
                            },
                            "message": {
                                "type": "string"
                            },
                            "metadata": {
                                "type": "object",
                                "additionalProperties": true
                            }
                        }
                    }
                }
            }
        },
        "metadata": {
            "type": "object",
            "description": "Additional custom metadata",
            "additionalProperties": true
        }
    }
}
