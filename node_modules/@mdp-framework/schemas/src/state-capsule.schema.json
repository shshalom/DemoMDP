{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mdp.dev/schemas/state-capsule/v1",
  "title": "StateCapsule",
  "description": "Portable state container for workflow context, decisions, and evidence",
  "type": "object",
  "required": ["id", "kind", "version", "created_at"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique capsule identifier (capsule://proj/<TEAM>/<kind>/<slug>)",
      "pattern": "^capsule://[a-z0-9_-]+/[A-Z0-9_-]+/[a-z0-9_-]+/[a-z0-9_-]+$"
    },
    "kind": {
      "type": "string",
      "description": "Capsule type (e.g., 'feature', 'issue', 'pr')",
      "enum": ["feature", "issue", "pr", "investigation", "custom"]
    },
    "version": {
      "type": "integer",
      "description": "Capsule version for optimistic concurrency control",
      "minimum": 1
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of capsule creation"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last update"
    },
    "ttl": {
      "type": "integer",
      "description": "Time-to-live in seconds (null = never expires)",
      "minimum": 0
    },
    "context": {
      "type": "object",
      "description": "Workflow context and metadata",
      "properties": {
        "repo": {
          "type": "string",
          "description": "Repository identifier (org/repo)"
        },
        "branch": {
          "type": "string"
        },
        "pr_number": {
          "type": "integer"
        },
        "issue_key": {
          "type": "string"
        },
        "initiator": {
          "type": "string",
          "description": "User or system that created the capsule"
        }
      },
      "additionalProperties": true
    },
    "decisions": {
      "type": "array",
      "description": "Ordered list of decisions and answers from patterns",
      "items": {
        "type": "object",
        "required": ["question", "answer", "timestamp"],
        "properties": {
          "question": {
            "type": "string",
            "description": "Question prompt or decision point"
          },
          "answer": {
            "description": "User or agent answer (any type)",
            "oneOf": [
              { "type": "string" },
              { "type": "number" },
              { "type": "boolean" },
              { "type": "object" },
              { "type": "array" }
            ]
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "source": {
            "type": "string",
            "enum": ["user", "agent", "system"]
          }
        }
      }
    },
    "evidence": {
      "type": "array",
      "description": "Quick evidence links (strings); use artifacts for rich/structured evidence",
      "items": {
        "type": "string",
        "description": "Evidence URI (e.g., gh://org/repo/PR/123/diff@abc123)"
      }
    },
    "policy_ids": {
      "type": "array",
      "description": "Resolved policy IDs applied to this capsule (id@YYYY.MM.DD - never channels)",
      "items": {
        "type": "string",
        "pattern": "^[a-z][a-z0-9-]*(?:\\.[a-z][a-z0-9-]*)+@[0-9]{4}\\.[0-9]{2}\\.[0-9]{2}$"
      }
    },
    "artifacts": {
      "type": "object",
      "description": "Workflow artifacts (patches, diffs, generated files)",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "content": {
            "type": "string"
          },
          "content_type": {
            "type": "string"
          },
          "size": {
            "type": "integer"
          },
          "hash": {
            "type": "string"
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional custom metadata",
      "additionalProperties": true
    }
  }
}
