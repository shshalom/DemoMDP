#!/usr/bin/env node
/**
 * MCP Server CLI
 *
 * Start the MCP server in stdio or HTTP mode
 */
import { createMCPServer } from './server.js';
import { createResolver } from '@mdp-framework/gateway';
import { createCapsuleStore } from '@mdp-framework/gateway/store';
import { PolicyRegistry } from '@mdp-framework/adapters';
async function main() {
    const args = process.argv.slice(2);
    const mode = args.includes('--http') ? 'http' : 'stdio';
    const portArg = args.find((arg) => arg.startsWith('--port='));
    const port = portArg ? parseInt(portArg.split('=')[1], 10) : 8080;
    // Setup resolver
    const registry = new PolicyRegistry({
        basePath: process.env.MLANG_POLICY_PATH || '.mlang/policies',
    });
    const resolver = createResolver({ registries: [registry] });
    // Setup store
    const store = await createCapsuleStore({
        backend: 'file',
        baseDir: process.env.MLANG_STATE_PATH || '.mlang/state/capsules',
    });
    // Create and start server
    const server = createMCPServer({ resolver, store });
    console.error(`Starting MCP server in ${mode} mode...`);
    if (mode === 'http') {
        console.error(`Listening on port ${port}`);
    }
    await server.start(mode, mode === 'http' ? port : undefined);
    const status = server.getStatus();
    console.error(`Server started with ${status.toolCount} tools`);
    console.error('Available tools:');
    server.getTools().forEach((tool) => {
        console.error(`  - ${tool.name}: ${tool.description}`);
    });
    // Handle shutdown
    process.on('SIGINT', async () => {
        console.error('\nShutting down...');
        await server.stop();
        await store.close();
        process.exit(0);
    });
    process.on('SIGTERM', async () => {
        console.error('\nShutting down...');
        await server.stop();
        await store.close();
        process.exit(0);
    });
}
main().catch((error) => {
    console.error('Failed to start MCP server:', error);
    process.exit(1);
});
//# sourceMappingURL=cli.js.map